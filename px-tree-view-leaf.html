<!--
Element renders a tree node that is a generic leaf with a label.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-tree-view-behaviors.html">
<link rel="import" href="../px-theme/px-theme-styles.html">
<link rel="import" href="css/px-tree-view-leaf-styles.html">

<dom-module id="px-tree-view-leaf">
  <template>
    <style include="px-tree-view-leaf-styles"></style>
    <style include="px-theme-styles"></style>

    <div id="label" class="tree-view-label">
      <template is="dom-if" if="[[ prefix ]]">
        <div id="prefix" class="tree-view-prefix tree-view-label-prefix">
          <template is="dom-repeat" id="prefix" items="[[ prefix ]]">
            <template is="dom-if" if="[[ !_isstr(item) ]]">
              <template is="dom-if" if="[[ item.icon ]]">
                <template is="dom-if" if="[[ item.background ]]">
                  <div class$="[[ _classifyIcon(item) ]]" style$="background-color:[[ item.background ]]">
                    <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                  </div>
                </template>

                <template is="dom-if" if="[[ !item.background ]]">
                  <div class$="[[ _classifyIcon(item) ]]">
                    <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                  </div>
                </template>
              </template>

              <template is="dom-if" if="[[ !item.icon ]]">
                <div class$="[[ item.class ]]">[[ item.content ]]</div>
              </template>
            </template>

            <template is="dom-if" if="[[ _isstr(item) ]]">
              <div>[[ item ]]</div>
            </template>
          </template>
        </div>
      </template>

      <a id="text" href="#" class="tree-view-text">[[ label ]]</a>

      <template is="dom-if" if="[[ postfix ]]">
        <div id="postfix" class="tree-view-postfix tree-view-label-postfix">
          <template is="dom-repeat"  id="postfix" items="[[ postfix ]]">
            <template is="dom-if" if="![[ _isstr(item) ]]">
              <template is="dom-if" if="[[ item.icon ]]">
                <div class="tree-view-icon">
                  <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                </div>
              </template>

              <template is="dom-if" if="[[ !item.icon ]]">
                <div class$="tree-view-postfix-icon [[ item.class ]]">[[ item.content ]]</div>
              </template>
            </template>

            <template is="dom-if" if="[[ _isstr(item) ]]">
              <div class="tree-view-postfix-icon">[[ item ]]</div>
            </template>
          </template>
        </div>
      </template>

      <template is="dom-if" if="[[ removable ]]">
        <div class="tree-view-remove-icon">
          <iron-icon icon="fa:fa-times" class="tree-view-iron-icon remove-icon" aria-hidden="true"></iron-icon>
        </div>
      </template>
    </div>
  </template>
</dom-module>

<script>
Polymer({
  is:'px-tree-view-leaf',
  behaviors:[Polymer.PX.TreeView],

  attached:function(){
    this.async(function() {
      this.tree   = this._ancestor('px-tree-view');
      this.branch = this._ancestor('px-tree-view-branch');
      this.parent = this.branch || this.tree;
      this.depth  = this.branch ? (this.branch.depth+1) : 0;

      if (this.parent){
        if (!this.parent._childnodes){
          this.parent._childnodes = [];
        }

        this.$.label.classList.add('tree-view-level-'+ this.depth);

        this.parent._childnodes[this.position]=this;
      }

      if (this.tree){
        if (this.tree.hasAttribute('lights-off')){
          this.setAttribute('lights-off','');
        }
      }
    });
  },

  /**
   * Component properties
   * @public
   * @property properties
   * @type Object
   */
  properties:{
    /**
     * Text label of the leaf
     * @property label
     * @type {String}
     */
    label:String,

    /**
     * Data object for the leaf that is passed through to all of the events
     * @property detail
     * @type {Object}
     */
    detail:{
      type:Object,
      value:function(){ return {}; }
    },

    /**
     * Content that can be prepended to leaf label
     * @property prefix
     * @type {String}
     */
    prefix:{
      type:Array,
      value:function(){ return []; }
    },

    /**
     * Content that can be appended to leaf label
     * @property postfix
     * @type {String}
     */
    postfix:{
      type:Array,
      value:function(){ return []; }
    },

    /**
     * Set to true to allow this node to be removed via a visable icon
     * @property removable
     * @type {Boolean}
     */
    removable:{
      type:Boolean,
      value:false,
      notify:true
    },

    /**
     * Toggles the disabled state of the leaf
     * @property disabled
     * @type {Boolean}
     */
    disabled:{
      type:Boolean,
      value:false,
      notify:true,
      observer:'_disabled'
    },

    /**
     * Toggles the selected state of the leaf
     * @property selected
     * @type {Boolean}
     */
    selected:{
      type:Boolean,
      value:false,
      notify:true,
      observer:'_selected'
    }
  },

  /**
   * Event listeners
   * @public
   * @property listeners
   * @type {Object}
   */
  listeners:{
    tap:'_ontap',
    mousedown:'_onmousedown',
    mouseup:'_onmouseup',
    mouseenter:'_onenter',
    mouseleave:'_onleave'
  },

  /**
   * Handles the ontap event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _ontap:function(e,detail){
    e = this._event(e);

    var src=detail.sourceEvent;
    src.preventDefault();
    src.stopPropagation();

    if (e.target.classList.contains('remove-icon')){
      this.remove();
    }
    else if (e.target === this.$.label || e.target === this.$.text){
      this.fire('px-tree-view-leaf-tap', this._detail());
    }
  },

  /**
   * Handles the onmousedown event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onmousedown:function(e){
    this.fire('px-tree-view-press', this._detail());
    this.fire('px-tree-view-leaf-press', this._detail());
  },

  /**
   * Handles the onmouseup event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onmouseup:function(e){
    e = this._event(e);

    this._select(e.target,e.shiftKey, e.ctrlKey, e.metaKey, e.altKey);

    this.fire('px-tree-view-release', this._detail());
    this.fire('px-tree-view-leaf-release', this._detail());
  },

  /**
   * Handles the onmouseenter event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onenter:function(e){
    this.fire('px-tree-view-enter', this._detail());
    this.fire('px-tree-view-leaf-enter', this._detail());
  },

  /**
   * Handles the onmouseleave event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onleave:function(){
    this.fire('px-tree-view-leave', this._detail());
    this.fire('px-tree-view-leaf-leave', this._detail());
  },


  /**
   * Handles the single and multi-selects
   * @private
   * @param {Element} elm Current element
   * @param {Boolean} shift True if shift key is pressed
   * @param {Boolean} ctrl True if ctrl key is pressed
   * @param {Boolean} meta True if meta key is pressed
   * @param {Boolean} alt True if alt key is pressed
   * @return {Void}
   */
  _select:function(elm,shift,ctrl,meta,alt){
    var last,nodes;

    if (this.tree){
      last  = this.tree._target,
      nodes = this.parent._childnodes;

      if (!this.disabled){
        if (!this.tree.singleSelect && (ctrl || meta)){
          if (this.selected){
            this.deselect();
          }
          else {
            this.select();
          }
        }
        else if (!this.tree.singleSelect && shift){
          if (last && last.depth === this.depth){
            if (last.position < this.position){
              this._each(nodes, function(node,i){
                if (i >= last.position && i <= this.position){
                  node.select();
                }
              });
            }
            else {
              var i=nodes.length;

              while(i>=0){
                if (i >= this.position && i <= last.position){
                  nodes[i].select();
                }

                --i;
              }
            }
          }
        }
        else {
          this._each(this._clone(this.tree.selected), function(node){
            if (node !== this){
              node.deselect();
            }
          });

          this.select();
        }

        this.tree._target=this;
      }
    }
  },

  /**
   * Returns all of the details for an event
   * @private
   * @return {Object}
   */
  _detail:function(extras){
    var detail = {
      type:'leaf',
      scope:this,
      data:this.detail
    };

    if (extras){
      this._each(extras, function(extra,key){
        if (this._isundef(detail[key])){
          detail[key]=extra;
        }
      });
    }

    return detail;
  },


  /**
   * Prevents default event on certain custom events created in a component.
   * To use in an event, watch the this._prevented property. If it's true, then
   * return the value 'this'.
   * @public
   * @param {Object} e
   * @return {Void}
   */
  preventDefault:function(e){
    var _this = this;
    this._prevented = true;

    setTimeout(function(){
      delete _this._prevented;
    },1);
  },



  /**
   * Removes the leaf from it's parent branch
   * @public
   * @return {Instance}
   */
  remove:function(){
    this.fire('px-tree-view-remove', this._detail());
    this.fire('px-tree-view-leaf-remove', this._detail());

    if (this._prevented){
      return this;
    }

    this.deselect();
    this.parent._remove(this.position);

    return this;
  },

  /**
   * Selects this leaf if it's not already selected
   * @public
   * @return {Instance}
   */
  select:function(){
    if (!this.disabled){
      var same=this.tree._target===this;

      if (this.tree.single){
        this.tree.deselect();
      }

      if (!this.selected){
        this.selected=true;
        this.tree._select(this);
      }

      if (!same){
        this.fire('px-tree-view-select', this._detail());
        this.fire('px-tree-view-leaf-select', this._detail());
      }
    }

    return this;
  },

  /**
   * Deselects this leaf if it's selected
   * @public
   * @return {Instance}
   */
  deselect:function(){
    if (this.selected){
      this.selected=false;

      this.tree._deselect(this);

      this.fire('px-tree-view-deselect', this._detail());
      this.fire('px-tree-view-leaf-deselect', this._detail());
    }

    return this;
  },

  /**
   * Sets the state of the node to be enabled
   * @public
   * @return {Instance}
   */
  enable:function(){
    if (this.disabled){
      this.disabled=false;

      this.fire('px-tree-view-enable', this._detail());
      this.fire('px-tree-view-leaf-enable', this._detail());
    }

    return this;
  },

  /**
   * Sets the state of the node to be disabled
   * @public
   * @return {Instance}
   */
  disable:function(){
    if (!this.disabled){
      this.disabled=true;

      this.fire('px-tree-view-disable', this._detail());
      this.fire('px-tree-view-leaf-disable', this._detail());
    }

    return this;
  }
});
</script>
