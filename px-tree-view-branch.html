<!--
Element renders a tree node that accepts children (items) and allows it to be toggled.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-tree-view-behaviors.html">
<link rel="import" href="px-tree-view-node.html">

<link rel="import" href="css/px-tree-view-branch-styles.html">
<link rel="import" href="../px-theme/px-theme-styles.html">
<link rel="import" href="../px-polymer-font-awesome/px-polymer-font-awesome.html">

<dom-module id="px-tree-view-branch">
  <template>
    <style include="px-tree-view-branch-styles"></style>
    <style include="px-theme-styles"></style>

    <div id="label" class="tree-view-label">
      <div id="toggle" class="tree-view-toggle">
        <iron-icon id="toggleicon" icon="fa:fa-caret-right" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
      </div>

      <template is="dom-if" if="[[ prefix ]]">
        <div id="prefix" class="tree-view-prefix tree-view-label-prefix">
          <template is="dom-repeat" items="[[ prefix ]]">
            <template is="dom-if" if="[[ !_isstr(item) ]]">
              <template is="dom-if" if="[[ item.icon ]]">
                <template is="dom-if" if="[[ item.background ]]">
                  <div class$="[[ _classifyIcon(item) ]]" style$="background-color:[[ item.background ]]">
                    <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                  </div>
                </template>

                <template is="dom-if" if="[[ !item.background ]]">
                  <div class$="[[ _classifyIcon(item) ]]">
                    <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                  </div>
                </template>
              </template>

              <template is="dom-if" if="[[ !item.icon ]]">
                <div class$="[[ item.class ]]">[[ item.content ]]</div>
              </template>
            </template>

            <template is="dom-if" if="[[ _isstr(item) ]]">
              <div>[[ item ]]</div>
            </template>
          </template>
        </div>
      </template>

      <a id="text" href="#" class="tree-view-text">[[ label ]]</a>

      <template is="dom-if" if="[[ postfix ]]">
        <div id="postfix" class="tree-view-postfix tree-view-label-postfix">
          <template is="dom-repeat" items="[[ postfix ]]">
            <template is="dom-if" if="[[ !_isstr(item) ]]">
              <template is="dom-if" if="[[ item.icon ]]">
                <div class="tree-view-icon">
                  <iron-icon icon$="fa:[[ item.icon ]]" class="tree-view-iron-icon" aria-hidden="true"></iron-icon>
                </div>
              </template>

              <template is="dom-if" if="[[ !item.icon ]]">
                <div class$="tree-view-postfix-icon [[ item.class ]]">[[ item.content ]]</div>
              </template>
            </template>

            <template is="dom-if" if="[[ _isstr(item) ]]">
              <div class="tree-view-postfix-icon">[[ item ]]</div>
            </template>
          </template>
        </div>
      </template>

      <template is="dom-if" if="[[ removable ]]">
        <div class="tree-view-remove-icon">
          <iron-icon icon="fa:fa-times" class="tree-view-iron-icon remove-icon" aria-hidden="true"></iron-icon>
        </div>
      </template>
    </div>

    <div id="container" class="tree-view-container">
      <template is="dom-if" if="[[ before ]]">
        <div id="before" class="tree-view-before">[[ before ]]</div>
      </template>

      <px-tree-view-node items="[[ items ]]"></px-tree-view-node>

      <template is="dom-if" if="[[ after ]]">
        <div id="after" class="tree-view-after">[[ after ]]</div>
      </template>
    </div>
  </template>
</dom-module>

<script>
Polymer({
  is:'px-tree-view-branch',
  behaviors:[Polymer.PX.TreeView],

  attached:function(){
    this.async(function(){
      this.tree   = this._ancestor('px-tree-view');
      this.branch = this._ancestor('px-tree-view-branch');
      this.parent = this.branch || this.tree;
      this.depth  = this.branch ? (this.branch.depth+1) : 0;

      if (this.parent){
        if (!this.parent._childnodes){
          this.parent._childnodes = [];
        }

        this.$.label.classList.add('tree-view-level-'+ this.depth);
        this.$.container.classList.add('tree-view-level-'+ this.depth);

        this.parent._childnodes[this.position]=this;
      }

      if (this.tree.lightsOff){
        this.setAttribute('lights-off','');
      }
    });
  },

  /**
   * Component properties
   * @public
   * @property properties
   * @type Object
   */
  properties:{
    /**
     * Full data structure of the tree
     * @property label
     * @type {String}
     */
    label:String,

    /**
     * Data node for the leaf
     * @property detail
     * @type {Object}
     */
    detail:{
      type:Object,
      value:function(){ return {}; }
    },

    /**
     * Full data structure of the tree
     * @property items
     * @type {Array}
     */
    items:{
      type:Array,
      value:function(){ return []; }
    },

    /**
     * Before content
     * @property before
     * @type {String}
     */
    before:String,

    /**
     * After content
     * @property after
     * @type {String}
     */
    after:String,

    /**
     * Content that can be prepended to branch label
     * @property prefix
     * @type {String}
     */
    prefix:String,

    /**
     * Content that can be appended to branch label
     * @property postfix
     * @type {String}
     */
    postfix:String,

    /**
     * Set to true to allow this node to be removed via a visable icon
     * @property removable
     * @type {Boolean}
     */
    removable:{
      type:Boolean,
      value:false,
      notify:false
    },

    /**
     * Toggles the disabled state of the branch
     * @property disabled
     * @type {Boolean}
     */
    disabled:{
      type:Boolean,
      value:false,
      notify:true,
      observer:'_disabled'
    },

    /**
     * Toggles the selected state of the branch
     * @property selected
     * @type {Boolean}
     */
    selected:{
      type:Boolean,
      value:false,
      notify:true,
      observer:'_selected'
    },

    /**
     * Toggles the expanded/collapsed state of the branch
     * @property disabled
     * @type {Boolean}
     */
    expanded:{
      type:Boolean,
      value:false,
      notify:true,
      observer:'_expanded'
    }
  },

  /**
   * Event listeners
   * @public
   * @property listeners
   * @type {Object}
   */
  listeners:{
    tap:'_ontap',
    mousedown:'_onmousedown',
    mouseup:'_onmouseup',
    dblclick:'_dblclick',
    mouseenter:'_onenter',
    mouseleave:'_onleave'
  },

  /**
   * Handles the ontap event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _ontap:function(e,detail){
    e = this._event(e);

    var src=detail.sourceEvent;
    src.preventDefault();
    src.stopPropagation();

    if (e.target === this.$.toggle || e.target === this.$.toggleicon){
      this.toggle();
    }
    else if (e.target === this.$.text){
      if (!this.tree.doubleClickBranches){
        this.toggle();
      }
    }
    else if (e.target.classList.contains('remove-icon')){
      this.remove();
    }

    if (e.target === this.$.label || e.target === this.$.text){
      this.fire('px-tree-view-branch-tap', this._detail());
    }
  },

  /**
   * Handles the dblclick event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _dblclick:function(e,detail){
    e = this._event(e);

    if (e.target === this.$.text){
      if (!this.disabled && this.tree.doubleClickBranches){
        this.toggle();
      }
    }
  },

  /**
   * Handles the onmousedown event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onmousedown:function(e){
    this.fire('px-tree-view-press', this._detail());
    this.fire('px-tree-view-branch-press', this._detail());
  },

  /**
   * Handles the onmousedown event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onmouseup:function(e,detail){
    e = this._event(e);

    this._select(e.target,e.shiftKey, e.ctrlKey, e.metaKey, e.altKey);

    this.fire('px-tree-view-release', this._detail());
    this.fire('px-tree-view-branch-release', this._detail());
  },

  /**
   * Handles the onmouseenter event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onenter:function(e,detail){
    this.fire('px-tree-view-enter', this._detail());
    this.fire('px-tree-view-branch-enter', this._detail());
  },

  /**
   * Handles the onmouseleave event
   * @private
   * @param {Event} e
   * @return {Void}
   */
  _onleave:function(e,detail){
    this.fire('px-tree-view-leave', this._detail());
    this.fire('px-tree-view-branchleave', this._detail());
  },


  /**
   * Handles the single and multi-selects
   * @private
   * @param {Element} elm Current element
   * @param {Boolean} shift True if shift key is pressed
   * @param {Boolean} ctrl True if ctrl key is pressed
   * @param {Boolean} meta True if meta key is pressed
   * @param {Boolean} alt True if alt key is pressed
   * @return {Void}
   */
  _select:function(elm,shift,ctrl,meta,alt){
    if (elm === this.$.label || elm === this.$.text){
      if (!this.disabled){
          if (!this.tree.singleSelect && (ctrl || meta)){
            if (this.selected){
              this.deselect();
            }
            else {
              this.select();
            }
          }
          else if (!this.tree.singleSelect && shift){
            if (this.tree._target && this.tree._target.depth === this.depth){
              var nodes = this.parent._childnodes,
              last = this.tree._target.position,
              current = this.position;

              if (last < current){
                this._each(nodes, function(node,i){
                  if (i >= last && i <= current){
                    node.select();
                  }
                });
              }
              else {
                var i=nodes.length;

                while(i>=0){
                  if (i >= current && i <= last){
                    nodes[i].select();
                  }

                  --i;
                }
              }
            }
          }
        else {
          this._each(this._clone(this.tree.selected), function(node){
            if (node !== this){
              node.deselect();
            }
          });

          this.select();
        }

        this.tree._target=this;
      }
    }
  },

  /**
   * Handles the property change of expanded
   * @private
   * @param {Boolean} expanded
   * @return {Void}
   */
  _expanded:function(expanded){
    this.toggleClass('expanded', expanded, this.$.label);
    this.toggleClass('expanded', expanded, this.$.container);
  },

  /**
   * Removes the passed index from as a child
   * @private
   * @param {Number} index
   * @return {Void}
   */
  _remove:function(index){
    this.splice('items', index, 1);
    this._childnodes.splice(index, 1);

    this._each(this._childnodes, function(node,i){
      node.position=i;
    });
  },

  /**
   * Returns all of the details for an event
   * @private
   * @return {Object}
   */
  _detail:function(extras){
    var detail = {
      type:'branch',
      scope:this,
      data:this.detail
    };

    if (extras){
      this._each(extras, function(extra,key){
        if (this._isundef(detail[key])){
          detail[key]=extra;
        }
      });
    }

    return detail;
  },




  /**
   * Returns a single child that exists in the root branch if an index is passed.
   * If the argument is undefined, all child nodes will be returned. If the argument
   * passed is an element and it's either a branch or leaf component, it will be returned.
   * @public
   * @param {Mixed} node (Optional) Numeric Index of a child or a child element
   * @return {Mixed} Element or array of elements
   */
  nodes:function(node){
    if (this._isundef(node)){
      return this._childnodes;
    }

    if (this._iselm(node)){
      if (this.isbranch(node) || this.isleaf(node)){
        return node;
      }

      return;
    }

    if (!this._childnodes){
      return [];
    }

    return this._childnodes[node];
  },

  /**
   * Returns true if the node is a branch
   * @public
   * @param {Element} node
   * @return {Boolean}
   */
  isbranch:function(node){
    return node && node.is==='px-tree-view-branch';
  },

  /**
   * Returns true if the node is a leaf
   * @public
   * @param {Element} node
   * @return {Boolean}
   */
  isleaf:function(node){
    return node && node.is==='px-tree-view-leaf';
  },

  /**
   * Prevents default event on certain custom events created in a component.
   * To use in an event, watch the this._prevented property. If it's true, then
   * return the value 'this'.
   * @public
   * @param {Object} e
   * @return {Void}
   */
  preventDefault:function(e){
    var _this = this;
    this._prevented = true;

    setTimeout(function(){
      delete _this._prevented;
    },1);
  },

  /**
   * This functions exactly as items() with one exception: It will always append a new child.
   * @public
   * @param {Mixed} node Object with node information, or an array of objects to insert
   * @param {Mixed} after (Optional) Position or element to inject the node or nodes after
   * @return {Instance}
   */
  insert:function(node,after){
    if (this._isarray(node)){
      this._each(node, function(node,i){
        this.insert(node,(this._isundef(after) ? after : after+i));
      });
    }
    else {
      if (!this._isundef(after)){
        if (this._iselm(after)){
          this._each(this.items, function(node,i){
            if (node===after){
              after=i;
              return true;
            }
          });
        }

        this.splice('items', after+1, 0, node);
        this._childnodes.splice(after+1, 0, node);

        this.fire('px-tree-view-insert', this._detail({ data:node }));
      }
      else {
        this.push('items', node);
        this.fire('px-tree-view-insert', this._detail({ data:node }));
      }
    }

    return this;
  },

  /**
   * This will flush the data and visual child node component from the parent node by the
   * index of the array (if an int is passed) or by the elelent of the child (if an element
   * is passed).
   * @public
   * @param {Mixed} node Node components or index of the component to remove
   * @return {Instance}
   */
  remove:function(node){
    if (this._iselm(node)){
      if (!this._isundef(node.position)){
        node.remove();
      }
    }
    else if (this._isnum(node)){
      this.remove(this.nodes(node));
    }
    else {
      this.fire('px-tree-view-remove', this._detail());
      this.fire('px-tree-view-branch-remove', this._detail());

      if (this._prevented){
        return this;
      }

      this.deselect();
      this.parent._remove(this.position);
    }

    return this;
  },

  /**
   * Flushes or removes all items of the current node. This will also remove any status
   * message that had been set for this current node.
   * @public
   * @return {Instance}
   */
  flush:function(){
    var node;

    this.before='';
    this.after='';

    if (this._childnodes){
      while(this._childnodes.length){
        node = this._last(this._childnodes);
        node.remove();
      }
    }

    this.fire('px-tree-view-flush', this._detail());
    this.fire('px-tree-view-branch-flush', this._detail());

    return this;
  },

  /**
   * Expands the branch so all of it's items are displayed
   * @public
   * @return {Instance}
   */
  expand:function(){
    if (!this.disabled){
      if (!this.expanded){
        this.expanded=true;

        this.fire('px-tree-view-expand', this._detail());

        if (!this.items.length){
          this._later(function(){
            this.fire('px-tree-view-empty', this._detail());
          });
        }
      }
    }

    return this;
  },

  /**
   * Collapses the branch by hiding all of it's items
   * @public
   * @return {Instance}
   */
  collapse:function(){
    if (!this.disabled){
      if (this.expanded){
        this.expanded=false;

        this._each(this._childnodes, function(node){
          node.deselect();
        });

        this.fire('px-tree-view-collapse', this._detail());
      }
    }

    return this;
  },

  /**
   * Toggles the expand/collpased state for the branch
   * @public
   * @return {Instance}
   */
  toggle:function(){
    if (!this.disabled){
      if (this.expanded){
        this.collapse();
      }
      else {
        this.expand();
      }

      this.fire('px-tree-view-toggle', this._detail());
    }

    return this;
  },

  /**
   * Sets the selected state for the branch
   * @public
   * @param {Mixed} index (Optional) Index of child node to select or array of child indexes to select
   * @return {Instance}
   */
  select:function(index){
    var node;

    if (this.tree.disableBranchSelect){
      return this;
    }

    if (this._isundef(index)){
      if (!this.disabled){
        var same=this.tree._target===this;

        if (!this.selected){
          this.selected=true;
          this.tree._select(this);
        }

        if (!same){
          this.fire('px-tree-view-select', this._detail());
          this.fire('px-tree-view-branch-select', this._detail());
        }
      }
    }
    else if (this._isarray(index)){
      this._each(index, function(i){
        this.select(i);
      });
    }
    else {
      node=this.nodes(index);

      if (this.tree.single){
        this.tree.deselect();
      }

      if (node){
        node.select();
      }
    }

    return this;
  },

  /**
   * Sets the node state to deselected.
   * @public
   * @param {Mixed} index (Optional) Index of child node to deselect or
   *                      array of child indexes to deselect
   * @return {Instance}
   */
  deselect:function(index){
    var node;

    if (this._isundef(index)){
      if (this.selected){
        this.selected=false;

        this.tree._deselect(this);

        this.fire('px-tree-view-deselect', this._detail());
        this.fire('px-tree-view-branch-deselect', this._detail());
      }
    }
    else if (this._isarray(index)){
      this._each(index, function(i){
        this.deselect(i);
      });
    }
    else {
      node=this.nodes(index);

      if (node){
        node.deselect();
      }
    }

    return this;
  },

  /**
   * Enables the node
   * @public
   * @param {Mixed} index (Optional) Index of child node to enable or
   *                      array of child indexes to enable
   * @return {Instance}
   */
  enable:function(index){
    var node;

    if (this._isundef(index)){
      if (this.disabled){
        this.disabled=false;

        this.fire('px-tree-view-enable', this._detail());
        this.fire('px-tree-view-branch-enable', this._detail());
      }
    }
    else if (this._isarray(index)){
      this._each(index, function(i){
        this.enable(i);
      });
    }
    else {
      node=this.nodes(index);

      if (node){
        node.enable();
      }
    }

    return this;
  },

  /**
   * Disables the node
   * @public
   * @param {Mixed} index (Optional) Index of child node to disable or
   *                      array of child indexes to disabled
   * @return {Instance}
   */
  disable:function(index){
    var node;

    if (this._isundef(index)){
      if (!this.disabled){
        this.disabled=true;

        this.fire('px-tree-view-disable', this._detail());
        this.fire('px-tree-view-branch-disable', this._detail());
      }
    }
    else if (this._isarray(index)){
      this._each(index, function(i){
        this.disable(i);
      });
    }
    else {
      node=this.nodes(index);

      if (node){
        node.disable();
      }
    }

    return this;
  }
});
</script>
