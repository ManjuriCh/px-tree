<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-graph.html"/>
<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-selectable.html"/>
<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-browsable.html"/>
<link rel="import" href="css/px-tree-styles.html">
<link rel="import" href="px-tree-node.html">
<link rel="import" href="px-tree-behavior.html"/>

<!--

### Usage
```
  <px-tree items='[{"label":"Label","items":[{"label":"Child"}]}]'></px-tree>
```

### Styling
The following custom properties are available for styling:

Custom property | Description
:----------------|:-------------
`--px-tree-text-color` | Text color for the tree
`--px-tree-text-color--hover` | Text color for hovered tree nodes
`--px-tree-background-color--hover` | Background color for hovered tree nodes
`--px-tree-text-color--selected` | Text color for selected tree nodes
`--px-tree-background-color--selected` | Background color for selected tree nodes

@element px-tree
@blurb Generic tree component
@homepage index.html
@demo index.html
-->

<dom-module id="px-tree">
  <template>
    <style include="px-tree-styles"></style>

    <ul>
      <template is="dom-repeat" items="[[items]]">
        <px-tree-node label="[[item.label]]"
                      items="[[_getItemProp(item, keys.children)]]"
                      item="[[item]]"
                      keys="[[keys]]"
                      is-active="[[_isItemActive(active, activePath, item, multiActive, active.*)]]"
                      is-selected="[[_isItemSelected(selected, item, multiSelect, selected.*)]]"
                      active="[[active]]"
                      active-path="[[activePath]]"
                      selected="[[selected]]"
                      can-open="[[_hasChildren(item, item.items)]]"
                      disable-branch-select="[[disableBranchSelect]]"
                      multi-select="[[multiSelect]]"
                      multi-active="[[multiActive]]">
        </px-tree-node>
      </template>
    </ul>

  </template>
</dom-module>

<script>

Polymer({
  is:'px-tree',

  behaviors: [
    PxAppBehavior.AssetGraph,
    PxAppBehavior.AssetSelectable,
    PxAppBehavior.AssetBrowsable,
    PxTreeBehavior
  ],

  listeners: {
    'px-tree-node-tapped' : '_handleNodeTapped'
  },

  properties: {
    /**
     * Changes the item properties (keys) that will be used internally to find
     * each item's unique id, label, children list, and icon.
     */
    keys: {
      type: Object,
      value: function() {
        return {
          'id' : 'label',
          'label' : 'label',
          'children' : 'items',
          'icon' : 'icon'
        }
      }
    },
    /**
     * If set to true, multiple nodes can be selected at the same time in the tree
     * by using the shift key (for selecting a range) or the ctrl/cmd key (for selecting individual nodes).
     */
    multiSelect: {
      type: Boolean,
      value: false
    },
    /**
     * If set to true, multiple nodes can be active (expanded) at the same time.
     * If set to false, expanding a node will cause other nodes to automatically collapse.
     */
    multiActive: {
      type: Boolean,
      value: false
    },
    /**
     * If set to true, branches (nodes with children) will not be selectable.
     * Clicking on a branch will still cause it to become active (expand), but it
     * will not be added to the selected property.
     */
    disableBranchSelect: {
      type: Boolean,
      value: false
    }

  },

  _handleNodeTapped: function(e) {
    const {shift, ctrl, item, isBranch, isActive, isSelected, isIcon} = e.detail;
    if(isBranch && !isActive) {
      this.fire('px-app-asset-should-be-activated', {'item' : item});
    }
    if(isBranch && isActive) {
      if(!this.multiActive && this._assetGraph.getNodeInfo(item).parent) {
        this.fire('px-app-asset-should-be-activated', {'item' : this._assetGraph.getNodeInfo(item).parent});
      }
      else {
        this.fire('px-app-asset-should-be-deactivated', {'item' : item});
      }
    }
    if(isBranch && this.disableBranchSelect || isIcon) return;
    if(isSelected && (ctrl || shift)) {
      this.fire('px-app-asset-should-be-deselected', {'item' : item});
      return;
    }
    if(!ctrl && !shift) {
      this._clearSelectedAsset('DOM_EVENT');
    }
    if(this.multiSelect && shift) {
      var index1 = this._assetGraph.getNodeInfo(item).siblings.indexOf(item),
          index2 = this._assetGraph.getNodeInfo(item).siblings.indexOf(this._lastSelection.item);
      if(index2 > -1 && index2 < index1) {
        this._assetGraph.getNodeInfo(item).siblings.slice(index2+1, index1+1).forEach(function(item) {
          this.select(item);
        }.bind(this));
      }
      else if(index2 > -1) {
        this._assetGraph.getNodeInfo(item).siblings.slice(index1, index2).forEach(function(item) {
          this.select(item);
        }.bind(this));
      }
    }
    else {
      this.fire('px-app-asset-should-be-selected', {'item' : item});
    }
  }

});
</script>
